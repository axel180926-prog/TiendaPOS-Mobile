import React, { useState, useRef } from 'react';
import { View, StyleSheet, ScrollView, Alert, TouchableOpacity, TextInput as RNTextInput } from 'react-native';
import { TextInput, Button, Card, SegmentedButtons, Text, Portal, Modal, List, IconButton } from 'react-native-paper';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { router } from 'expo-router';
import * as queries from '@/lib/database/queries';
import { formatearMoneda } from '@/lib/utils/formatters';

const CATEGORIAS = [
  'Bebidas',
  'Botanas',
  'Abarrotes',
  'Panader칤a',
  'Galletas',
  'Dulces',
  'Sopas',
  'Condimentos',
  'Limpieza',
  'L치cteos y Huevos',
  'Enlatados',
  'Salsas',
  'Bebidas Calientes',
  'Higiene',
];

export default function AgregarProductoScreen() {
  const [loading, setLoading] = useState(false);
  const [categoriaSelectorVisible, setCategoriaSelectorVisible] = useState(false);
  const scannerInputRef = useRef<any>(null);
  const [scannerBuffer, setScannerBuffer] = useState('');

  // Campos del formulario
  const [codigoBarras, setCodigoBarras] = useState('');
  const [nombre, setNombre] = useState('');
  const [descripcion, setDescripcion] = useState('');
  const [categoria, setCategoria] = useState('Abarrotes');
  const [marca, setMarca] = useState('');
  const [presentacion, setPresentacion] = useState('');
  const [sku, setSku] = useState('');
  const [precioCompra, setPrecioCompra] = useState('');
  const [precioVenta, setPrecioVenta] = useState('');
  const [stock, setStock] = useState('');
  const [stockMinimo, setStockMinimo] = useState('5');
  const [unidadMedida, setUnidadMedida] = useState('Pieza');

  const unidades = [
    { value: 'Pieza', label: 'Pieza' },
    { value: 'Kg', label: 'Kg' },
    { value: 'Litro', label: 'Litro' },
  ];

  // Funci칩n para manejar el esc치ner
  const handleScannerInput = (text: string) => {
    setScannerBuffer(text);
  };

  const handleBarcodeScanned = async (codigo: string) => {
    setCodigoBarras(codigo);
    setScannerBuffer('');

    // Verificar si el producto ya existe
    try {
      const existe = await queries.obtenerProductoPorCodigo(codigo);
      if (existe) {
        Alert.alert(
          'Producto Existente',
          `Ya existe un producto con este c칩digo:\n\n${existe.nombre}\n${formatearMoneda(existe.precioVenta)}`,
          [
            { text: 'Cancelar', style: 'cancel' },
            {
              text: 'Ver Producto',
              onPress: () => router.replace(`/productos/editar/${existe.id}`)
            }
          ]
        );
      }
    } catch (error) {
      // El producto no existe, continuar
    }
  };

  const handleScanButton = () => {
    scannerInputRef.current?.focus();
    Alert.alert(
      'Esc치ner Activado',
      'Escanea el c칩digo de barras del producto con tu esc치ner USB/Bluetooth',
      [{ text: 'OK' }]
    );
  };

  // Funci칩n para aplicar margen de ganancia
  const aplicarMargen = (porcentaje: number) => {
    if (!precioCompra) {
      Alert.alert('Aviso', 'Primero ingresa el precio de compra');
      return;
    }
    const compra = parseFloat(precioCompra);
    const venta = compra * (1 + porcentaje / 100);
    setPrecioVenta(venta.toFixed(2));
  };

  const validarFormulario = () => {
    if (!codigoBarras.trim()) {
      Alert.alert('Error', 'El c칩digo de barras es obligatorio');
      return false;
    }
    if (!nombre.trim()) {
      Alert.alert('Error', 'El nombre es obligatorio');
      return false;
    }
    if (!precioVenta || parseFloat(precioVenta) <= 0) {
      Alert.alert('Error', 'El precio de venta debe ser mayor a 0');
      return false;
    }
    if (!stock || parseInt(stock) < 0) {
      Alert.alert('Error', 'El stock debe ser 0 o mayor');
      return false;
    }

    const compra = parseFloat(precioCompra) || 0;
    const venta = parseFloat(precioVenta);
    if (compra > venta) {
      return new Promise((resolve) => {
        Alert.alert(
          'Advertencia',
          'El precio de compra es mayor al precio de venta. Esto resultar치 en p칠rdidas. 쮻esea continuar?',
          [
            { text: 'Cancelar', style: 'cancel', onPress: () => resolve(false) },
            { text: 'Continuar', onPress: () => resolve(true) }
          ]
        );
      });
    }
    return true;
  };

  const handleGuardar = async () => {
    const esValido = await validarFormulario();
    if (!esValido) return;

    try {
      setLoading(true);

      const nuevoProducto = {
        codigoBarras: codigoBarras.trim(),
        nombre: nombre.trim(),
        descripcion: descripcion.trim() || undefined,
        categoria: categoria || undefined,
        marca: marca.trim() || undefined,
        presentacion: presentacion.trim() || undefined,
        sku: sku.trim() || undefined,
        precioCompra: parseFloat(precioCompra) || 0,
        precioVenta: parseFloat(precioVenta),
        stock: parseInt(stock),
        stockMinimo: parseInt(stockMinimo),
        unidadMedida: unidadMedida,
        activo: true,
      };

      await queries.crearProducto(nuevoProducto);

      Alert.alert('칄xito', 'Producto agregado correctamente', [
        {
          text: 'OK',
          onPress: () => router.back(),
        },
      ]);
    } catch (error: any) {
      console.error('Error al guardar producto:', error);
      if (error.message?.includes('UNIQUE')) {
        Alert.alert('Error', 'Ya existe un producto con ese c칩digo de barras');
      } else {
        Alert.alert('Error', 'No se pudo guardar el producto');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <ScrollView style={styles.container}>
      {/* Input oculto para esc치ner bluetooth */}
      <RNTextInput
        ref={scannerInputRef}
        value={scannerBuffer}
        onChangeText={handleScannerInput}
        showSoftInputOnFocus={false}
        keyboardType="numeric"
        onSubmitEditing={(e) => {
          const code = e.nativeEvent.text.trim();
          if (code) handleBarcodeScanned(code);
        }}
        style={styles.hiddenInput}
      />

      <Card style={styles.card}>
        <Card.Title title="游닍 Informaci칩n B치sica" titleStyle={styles.cardTitleBold} />
        <Card.Content>
          {/* C칩digo de Barras con bot칩n de escanear */}
          <View style={styles.fieldWithButton}>
            <TextInput
              label="C칩digo de Barras *"
              value={codigoBarras}
              onChangeText={setCodigoBarras}
              mode="outlined"
              style={[styles.input, styles.inputFlex]}
              keyboardType="numeric"
              placeholder="7501000110049"
            />
            <IconButton
              icon="barcode-scan"
              mode="contained"
              size={28}
              onPress={handleScanButton}
              style={styles.scanButton}
              containerColor="#2196f3"
              iconColor="#fff"
            />
          </View>

          <TextInput
            label="Nombre del Producto *"
            value={nombre}
            onChangeText={setNombre}
            mode="outlined"
            style={styles.input}
            placeholder="Coca-Cola 600ml"
          />

          <TextInput
            label="Descripci칩n"
            value={descripcion}
            onChangeText={setDescripcion}
            mode="outlined"
            multiline
            numberOfLines={2}
            style={styles.input}
            placeholder="Refresco de cola 600ml"
          />

          <TouchableOpacity onPress={() => setCategoriaSelectorVisible(true)}>
            <View pointerEvents="none">
              <TextInput
                label="Categor칤a"
                value={categoria}
                mode="outlined"
                style={styles.input}
                right={<TextInput.Icon icon="chevron-down" />}
                editable={false}
              />
            </View>
          </TouchableOpacity>
        </Card.Content>
      </Card>

      <Card style={styles.card}>
        <Card.Title title="Detalles del Producto" />
        <Card.Content>
          <TextInput
            label="Marca"
            value={marca}
            onChangeText={setMarca}
            mode="outlined"
            style={styles.input}
            placeholder="Coca-Cola"
          />

          <TextInput
            label="Presentaci칩n"
            value={presentacion}
            onChangeText={setPresentacion}
            mode="outlined"
            style={styles.input}
            placeholder="600ml"
          />

          <TextInput
            label="SKU"
            value={sku}
            onChangeText={setSku}
            mode="outlined"
            style={styles.input}
            placeholder="CC-600ML"
          />
        </Card.Content>
      </Card>

      <Card style={[styles.card, styles.cardPrecios]}>
        <Card.Title title="游눯 Precios" titleStyle={styles.cardTitleBold} />
        <Card.Content>
          {/* Precio de Venta DESTACADO */}
          <TextInput
            label="Precio de Venta (al p칰blico) *"
            value={precioVenta}
            onChangeText={setPrecioVenta}
            mode="outlined"
            keyboardType="decimal-pad"
            style={[styles.input, styles.precioVentaInput]}
            left={<TextInput.Affix text="$" textStyle={styles.dollarSign} />}
            placeholder="15.00"
            textStyle={styles.precioVentaText}
          />

          <TextInput
            label="Precio de Compra (proveedor)"
            value={precioCompra}
            onChangeText={setPrecioCompra}
            mode="outlined"
            keyboardType="decimal-pad"
            style={styles.input}
            left={<TextInput.Affix text="$" />}
            placeholder="9.30"
          />

          {/* GANANCIA MUY VISIBLE */}
          {precioCompra && precioVenta && (
            <Card style={styles.gananciaCardGrande}>
              <Card.Content>
                <View style={styles.gananciaRow}>
                  <MaterialCommunityIcons
                    name="cash-multiple"
                    size={40}
                    color="#4caf50"
                  />
                  <View style={styles.gananciaInfo}>
                    <Text variant="labelLarge" style={styles.gananciaLabel}>
                      游눯 Ganancia por unidad
                    </Text>
                    <Text variant="displaySmall" style={[
                      styles.gananciaValorGrande,
                      (parseFloat(precioVenta) - parseFloat(precioCompra)) < 0 && styles.gananciaNegativaGrande
                    ]}>
                      {formatearMoneda(parseFloat(precioVenta) - parseFloat(precioCompra))}
                    </Text>
                    {parseFloat(precioCompra) > 0 && (
                      <Text variant="titleMedium" style={styles.gananciaPorcentajeGrande}>
                        {(((parseFloat(precioVenta) - parseFloat(precioCompra)) / parseFloat(precioCompra)) * 100).toFixed(1)}% de margen
                      </Text>
                    )}
                  </View>
                </View>
              </Card.Content>
            </Card>
          )}

          {/* Calculadora R치pida */}
          <View style={styles.calculadoraQuick}>
            <Text variant="bodyMedium" style={styles.calculadoraLabel}>
              游눠 Aplicar margen de ganancia:
            </Text>
            <View style={styles.margenButtons}>
              <Button mode="outlined" compact onPress={() => aplicarMargen(20)} style={styles.margenButton}>
                +20%
              </Button>
              <Button mode="outlined" compact onPress={() => aplicarMargen(30)} style={styles.margenButton}>
                +30%
              </Button>
              <Button mode="outlined" compact onPress={() => aplicarMargen(50)} style={styles.margenButton}>
                +50%
              </Button>
              <Button mode="outlined" compact onPress={() => aplicarMargen(100)} style={styles.margenButton}>
                +100%
              </Button>
            </View>
          </View>

          <TextInput
            label="Stock Inicial *"
            value={stock}
            onChangeText={setStock}
            mode="outlined"
            keyboardType="numeric"
            style={styles.input}
            placeholder="50"
          />

          <TextInput
            label="Stock M칤nimo"
            value={stockMinimo}
            onChangeText={setStockMinimo}
            mode="outlined"
            keyboardType="numeric"
            style={styles.input}
            placeholder="10"
          />

          <SegmentedButtons
            value={unidadMedida}
            onValueChange={setUnidadMedida}
            buttons={unidades}
            style={styles.segmented}
          />
        </Card.Content>
      </Card>

      <Card style={styles.card}>
        <Card.Content>
          <View style={styles.buttonRow}>
            <Button
              mode="outlined"
              onPress={() => router.back()}
              style={styles.button}
              disabled={loading}
            >
              Cancelar
            </Button>
            <Button
              mode="contained"
              onPress={handleGuardar}
              style={styles.button}
              loading={loading}
              icon="content-save"
            >
              Guardar
            </Button>
          </View>
        </Card.Content>
      </Card>

      <View style={styles.spacer} />

      {/* Modal de Selecci칩n de Categor칤a */}
      <Portal>
        <Modal
          visible={categoriaSelectorVisible}
          onDismiss={() => setCategoriaSelectorVisible(false)}
          contentContainerStyle={styles.modalContainer}
        >
          <Card>
            <Card.Title title="Seleccionar Categor칤a" />
            <Card.Content>
              <ScrollView style={styles.modalScrollView}>
                {CATEGORIAS.map((cat) => (
                  <List.Item
                    key={cat}
                    title={cat}
                    onPress={() => {
                      setCategoria(cat);
                      setCategoriaSelectorVisible(false);
                    }}
                    left={(props) => (
                      <List.Icon
                        {...props}
                        icon={categoria === cat ? 'check-circle' : 'circle-outline'}
                        color={categoria === cat ? '#4caf50' : '#999'}
                      />
                    )}
                    style={categoria === cat ? styles.selectedItem : undefined}
                  />
                ))}
              </ScrollView>
            </Card.Content>
            <Card.Actions>
              <Button onPress={() => setCategoriaSelectorVisible(false)}>
                Cerrar
              </Button>
            </Card.Actions>
          </Card>
        </Modal>
      </Portal>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  card: {
    margin: 10,
  },
  input: {
    marginBottom: 15,
  },
  segmented: {
    marginTop: 10,
  },
  gananciaCard: {
    marginBottom: 15,
    backgroundColor: '#e8f5e9',
  },
  gananciaContainer: {
    alignItems: 'center',
  },
  gananciaValue: {
    color: '#4caf50',
    fontWeight: 'bold',
    marginTop: 4,
  },
  gananciaNegativa: {
    color: '#f44336',
  },
  gananciaPorcentaje: {
    color: '#2e7d32',
  },
  buttonRow: {
    flexDirection: 'row',
    gap: 10,
    marginTop: 10,
  },
  button: {
    flex: 1,
  },
  spacer: {
    height: 20,
  },
  modalContainer: {
    backgroundColor: 'white',
    padding: 20,
    margin: 20,
    borderRadius: 12,
    maxHeight: '80%',
  },
  modalScrollView: {
    maxHeight: 400,
  },
  selectedItem: {
    backgroundColor: '#e8f5e9',
  },
  // Nuevos estilos para mejoras
  hiddenInput: {
    position: 'absolute',
    left: -9999,
    width: 1,
    height: 1,
  },
  cardTitleBold: {
    fontWeight: '700',
    fontSize: 18,
  },
  fieldWithButton: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: 8,
    marginBottom: 15,
  },
  inputFlex: {
    flex: 1,
    marginBottom: 0,
  },
  scanButton: {
    marginTop: 8,
  },
  cardPrecios: {
    borderWidth: 2,
    borderColor: '#2196f3',
    backgroundColor: '#f8f9fa',
  },
  precioVentaInput: {
    backgroundColor: '#e3f2fd',
    borderWidth: 2,
    borderColor: '#2196f3',
  },
  precioVentaText: {
    fontSize: 20,
    fontWeight: '700',
  },
  dollarSign: {
    fontSize: 20,
    fontWeight: '700',
    color: '#2196f3',
  },
  gananciaCardGrande: {
    backgroundColor: '#e8f5e9',
    marginVertical: 16,
    borderWidth: 3,
    borderColor: '#4caf50',
    elevation: 4,
    borderRadius: 12,
  },
  gananciaRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 16,
  },
  gananciaInfo: {
    flex: 1,
  },
  gananciaLabel: {
    fontWeight: '600',
    color: '#2e7d32',
    marginBottom: 4,
  },
  gananciaValorGrande: {
    fontSize: 32,
    fontWeight: '700',
    color: '#2e7d32',
    marginTop: 4,
  },
  gananciaNegativaGrande: {
    color: '#d32f2f',
  },
  gananciaPorcentajeGrande: {
    fontSize: 16,
    fontWeight: '600',
    color: '#388e3c',
    marginTop: 4,
  },
  calculadoraQuick: {
    marginTop: 16,
    padding: 12,
    backgroundColor: '#fff3e0',
    borderRadius: 8,
    borderWidth: 1,
    borderColor: '#ff9800',
  },
  calculadoraLabel: {
    fontWeight: '600',
    color: '#e65100',
    marginBottom: 8,
  },
  margenButtons: {
    flexDirection: 'row',
    gap: 8,
    flexWrap: 'wrap',
  },
  margenButton: {
    flex: 1,
    minWidth: 70,
  },
});
